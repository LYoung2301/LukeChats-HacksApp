
@page
@model RetailMonolith.Pages.Products.IndexModel
@{
    ViewData["Title"] = "Products";
}
<h2>Products</h2>

<div class="container">
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
        @foreach (var product in Model.Products)
        {
            <div class="card">
                <img src="@Model.GetImageForCategory(product.Category)"
                     class="card-img-top" alt="@product.Name" style="object-fit: cover; height: 250px;">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">@product.Name</h5>
                    <p class="card-text text-muted mb-2">@product.Category</p>
                    <h6 class="fw-semibold mb-3">@product.Price.ToString("C")</h6>
                    <form method="post" asp-page-handler="AddToCart">
                        <input type="hidden" name="productId" value="@product.Id" />
                        <button type="submit" class="btn btn-primary">Add to Cart</button>
                    </form>
                </div>
            </div>
        }
    </div>
</div>
<a class="btn btn-outline-secondary" href="/Cart">View Cart</a>


<!-- Chatbot Popup Trigger Button -->
<button id="open-chatbot" style="position:fixed; bottom:30px; right:30px; z-index:999; border-radius:50px; box-shadow:0 2px 8px rgba(0,0,0,0.15); padding:12px 24px; font-size:1.1rem;" class="btn btn-primary">
    <i class="bi bi-chat-dots" style="font-size:1.3rem; margin-right:8px;"></i> Chat with us!
</button>

<!-- Chatbot Popup HTML -->
<div id="chatbot-popup" style="display:none; position:fixed; bottom:90px; right:30px; width:370px; background:#f8f9fa; border-radius:18px; box-shadow:0 4px 24px rgba(0,0,0,0.18); z-index:1000;">
    <div style="padding:16px 18px; border-bottom:1px solid #e3e3e3; background:#1b6ec2; color:#fff; border-top-left-radius:18px; border-top-right-radius:18px; display:flex; align-items:center;">
        <img src="https://ui-avatars.com/api/?name=Bot&background=1b6ec2&color=fff&size=32" style="width:32px; height:32px; border-radius:50%; margin-right:10px;" alt="Bot Avatar">
        <span style="font-weight:bold; font-size:1.1rem;">Retail Assistant</span>
        <button id="chatbot-close" type="button" class="btn btn-light btn-sm" style="margin-left:auto;">&times;</button>
    </div>
    <div id="chatbot-messages" style="height:270px; overflow-y:auto; padding:18px; background:#fff; border-bottom:1px solid #e3e3e3;"></div>
    <div style="padding:14px 18px; background:#f8f9fa; border-bottom-left-radius:18px; border-bottom-right-radius:18px;">
        <div style="display:flex; gap:8px;">
            <input type="text" id="chatbot-input" style="flex:1; border-radius:12px; border:1px solid #e3e3e3; padding:8px 12px; font-size:1rem;" placeholder="Type your message..." />
            <button id="chatbot-send" type="button" class="btn btn-success btn-sm" style="border-radius:12px;">Send</button>
        </div>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script>
        const popup = document.getElementById('chatbot-popup');
        const openBtn = document.getElementById('open-chatbot');
        const closeBtn = document.getElementById('chatbot-close');
        const sendBtn = document.getElementById('chatbot-send');
        const input = document.getElementById('chatbot-input');
        const messages = document.getElementById('chatbot-messages');

        openBtn.onclick = () => { popup.style.display = 'block'; openBtn.style.display = 'none'; };
        closeBtn.onclick = () => { popup.style.display = 'none'; openBtn.style.display = 'block'; };
        sendBtn.onclick = sendMessage;
        input.addEventListener('keydown', function(e) { if (e.key === 'Enter') sendMessage(); });

        function appendMessage(role, text) {
            const div = document.createElement('div');
            div.style.display = 'flex';
            div.style.marginBottom = '12px';
            if (role === 'You') {
                div.innerHTML = `
                    <div style='margin-left:auto; display:flex; align-items:center;'>
                        <span style='background:#e3e3e3; color:#333; padding:8px 14px; border-radius:16px 16px 2px 16px; font-size:1rem; max-width:220px; word-break:break-word;'>${text}</span>
                        <img src='https://ui-avatars.com/api/?name=You&background=6c757d&color=fff&size=28' style='width:28px; height:28px; border-radius:50%; margin-left:8px;' alt='User Avatar'>
                    </div>
                `;
            } else {
                div.innerHTML = `
                    <div style='display:flex; align-items:center;'>
                        <img src='https://ui-avatars.com/api/?name=Bot&background=1b6ec2&color=fff&size=28' style='width:28px; height:28px; border-radius:50%; margin-right:8px;' alt='Bot Avatar'>
                        <span style='background:#1b6ec2; color:#fff; padding:8px 14px; border-radius:16px 16px 16px 2px; font-size:1rem; max-width:220px; word-break:break-word;'>${text}</span>
                    </div>
                `;
            }
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }

        function sendMessage() {
            const userText = input.value.trim();
            if (!userText) return;
            appendMessage('You', userText);
            input.value = '';
            fetch('/api/chatbot', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: userText })
            })
            .then(res => res.json())
            .then(data => {
                appendMessage('Bot', data.reply);
            })
            .catch(() => {
                appendMessage('Bot', 'Sorry, something went wrong.');
            });
        }
    </script>
}
